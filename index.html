<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WaxAlert</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#0b0b0b">

  <style>
    :root { --navH: 62px; --radius: 14px; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0b0b0b;
      color: #fff;
    }
    .content {
      padding: 16px 16px calc(var(--navH) + 18px);
      max-width: 900px;
      margin: 0 auto;
    }
    .row { display:flex; gap:10px; align-items:center; }
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 14px;
    }
    h2 { margin: 0 0 10px; font-size: 20px; }
    .muted { opacity: 0.8; font-size: 13px; line-height: 1.35; }
    .small { opacity: 0.7; font-size: 12px; }
    .spacer { height: 12px; }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background:#111;
      color:#fff;
      font-size:16px;
    }

    button.primary, button.ghost {
      width:100%;
      margin-top:10px;
      padding: 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
    }

    button.primary {
      border:0;
      background:#fff;
      color:#000;
    }

    button.ghost {
      border:1px solid rgba(255,255,255,0.2);
      background:transparent;
      color:#fff;
    }

    .list { margin-top: 12px; display: grid; gap: 10px; }

    .suggestion { cursor:pointer; }
    .suggestion .title { font-weight:700; }
    .suggestion .meta { font-size:12px; opacity:0.8; }

    .bottomNav {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--navH);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 10px;
      background: #0b0b0b;
      border-top: 1px solid rgba(255,255,255,0.12);
      max-width: 900px;
      margin: 0 auto;
    }

    .navBtn {
      border:0;
      background:transparent;
      color:#fff;
      opacity:0.7;
      padding:10px;
      border-radius:14px;
    }

    .navBtn.active {
      background: rgba(255,255,255,0.12);
      opacity:1;
    }

    .view { display:none; }
    .view.active { display:block; }

    .kv {
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
  </style>
</head>

<body>
<main class="content">

<section class="view active" id="view-search">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h2>WaxAlert</h2>
      <div class="small" id="buildTag"></div>
    </div>

    <div class="muted">
      Start typing. Tap a match to use the exact Products eBayURL.
    </div>

    <div class="small" id="catalogStatus"></div>
    <div class="spacer"></div>

    <input id="q" placeholder="Type: dune chrome hobby, topps chrome hobby" />
    <div class="list" id="suggestions"></div>

    <button class="primary" id="btnSearch">Search</button>
    <button class="ghost" id="btnLast">Use last query</button>

    <div class="small" id="lastQuery"></div>
    <div class="small" id="selectedProduct"></div>
  </div>

  <div class="list" id="results"></div>
</section>

</main>

<nav class="bottomNav">
  <button class="navBtn active">Search</button>
</nav>

<script>
/* ---------------- CONFIG ---------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbyHeOMZV8sf2XwvAKxJwVFDOxeXBiJJ2HkILf3BlkaAx7ytONz7NTwkwozQucvxEEsCig/exec";
const APP_VERSION = "2026-01-04-01";

document.getElementById("buildTag").textContent = "v" + APP_VERSION;

/* ---------------- SERVICE WORKER ---------------- */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () =>
    navigator.serviceWorker.register(`/sw.js?v=${APP_VERSION}`)
  );
}

/* ---------------- HELPERS ---------------- */
const catalogStatusEl = document.getElementById("catalogStatus");
function setCatalogStatus(msg){ catalogStatusEl.textContent = msg || ""; }

function normalize(s){ return String(s||"").toLowerCase(); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

/* ---------------- API ---------------- */
async function api(action,payload){
  const r = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({action,payload})
  });
  const t = await r.text();
  try { return JSON.parse(t); }
  catch { return { ok:false,error:"Non-JSON response",preview:t.slice(0,200) }; }
}

/* ---------------- CATALOG ---------------- */
let PRODUCT_CATALOG = [];
let SELECTED_PRODUCT = null;

async function loadCatalog(){
  const cached = localStorage.getItem("waxalert_products_v1");
  if(cached){
    PRODUCT_CATALOG = JSON.parse(cached)||[];
    setCatalogStatus(`Catalog: ${PRODUCT_CATALOG.length} (cached)`);
  } else {
    setCatalogStatus("Catalog: loadingâ€¦");
  }

  const data = await api("products",{});
  if(!data || !data.ok || !Array.isArray(data.products)){
    setCatalogStatus("Catalog API error");
    console.log(data);
    return;
  }

  PRODUCT_CATALOG = data.products;
  localStorage.setItem("waxalert_products_v1",JSON.stringify(PRODUCT_CATALOG));
  setCatalogStatus(`Catalog: ${PRODUCT_CATALOG.length} (live)`);
}

function filterCatalog(q){
  const tokens = normalize(q).split(/\s+/).filter(Boolean);
  return PRODUCT_CATALOG.filter(p=>{
    const hay = normalize(p.displayName+" "+p.keywords+" "+p.code);
    return tokens.every(t=>hay.includes(t));
  });
}

/* ---------------- TYPEAHEAD ---------------- */
const qInput = document.getElementById("q");
const suggestionsEl = document.getElementById("suggestions");
const selectedEl = document.getElementById("selectedProduct");

qInput.addEventListener("input",()=>{
  SELECTED_PRODUCT=null;
  const m = filterCatalog(qInput.value);
  suggestionsEl.innerHTML = m.slice(0,12).map(p=>`
    <div class="card suggestion" data-code="${p.code}">
      <div class="title">${escapeHTML(p.displayName)}</div>
      <div class="meta">${escapeHTML(p.keywords||"")}</div>
    </div>
  `).join("");
});

suggestionsEl.addEventListener("click",e=>{
  const c = e.target.closest("[data-code]");
  if(!c) return;
  const p = PRODUCT_CATALOG.find(x=>x.code===c.dataset.code);
  if(!p) return;
  SELECTED_PRODUCT=p;
  qInput.value=p.displayName;
  selectedEl.textContent=`Selected: ${p.displayName}`;
  suggestionsEl.innerHTML="";
});

/* ---------------- INIT ---------------- */
loadCatalog();
</script>
</body>
</html>
