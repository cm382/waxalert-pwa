<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WaxAlert</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b0b0b">

  <style>
    :root {
      --bg: #0b0b0b;
      --text: #ffffff;
      --muted: rgba(255,255,255,.7);
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --input: #111;
      --primary: #ffffff;
      --primaryText: #000000;
    }

    [data-theme="light"] {
      --bg: #ffffff;
      --text: #111111;
      --muted: rgba(0,0,0,.6);
      --card: rgba(0,0,0,.04);
      --border: rgba(0,0,0,.12);
      --input: #ffffff;
      --primary: #111111;
      --primaryText: #ffffff;
    }

    html,body { margin:0; height:100%; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); }
    main { max-width:900px; margin:0 auto; padding:16px; }

    .top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
    }

    h1 { margin:0; font-size:22px; }
    .small { font-size:12px; opacity:.7; }

    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }

    input {
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--input);
      color:var(--text);
      font-size:16px;
      box-sizing:border-box;
    }

    button {
      padding:12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
    }

    .primary {
      background:var(--primary);
      color:var(--primaryText);
      border:none;
      width:100%;
    }

    .ghost {
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      width:100%;
    }

    .row { display:flex; gap:10px; }
    .list { margin-top:12px; display:grid; gap:10px; }

    .suggestion { cursor:pointer; }
    .suggestion b { font-size:15px; }

    .kv {
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid var(--border);
    }

    .kv:last-child { border-bottom:none; }

    .themeBtn {
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
    }
  </style>
</head>

<body>
<main>

  <div class="top">
    <div>
      <h1>WaxAlert</h1>
      <div class="small">v5</div>
    </div>
    <button class="themeBtn" id="themeToggle">Theme</button>
  </div>

  <div class="card">
    <div class="small" style="margin-bottom:8px">
      Type and select a product. Matching uses keywords, but only product names are shown.
    </div>

    <input id="q" placeholder="Ex: 2025-26 Topps Midnight Basketball" />

    <div class="list" id="suggestions"></div>

    <div class="row" style="margin-top:12px">
      <button class="primary" id="searchBtn">Search</button>
      <button class="ghost" id="clearBtn">Clear</button>
    </div>
  </div>

  <div class="list" id="results"></div>

</main>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwAOfPLpnJg7W1Vwn1VWEgSSGG_6bSEtJgu9_K6HYSKZPUmw-6eaKzTWEoKO2569Qj_/exec";

  let PRODUCTS = [];
  let SELECTED = null;

  const q = document.getElementById("q");
  const suggestions = document.getElementById("suggestions");
  const results = document.getElementById("results");

  async function api(action, payload) {
    return fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body:JSON.stringify({ action, payload })
    }).then(r=>r.json());
  }

  function norm(s){ return (s||"").toLowerCase(); }

  function renderSuggestions(list){
    suggestions.innerHTML = list.slice(0,10).map(p => `
      <div class="card suggestion" data-code="${p.code}">
        <b>${p.displayName}</b>
      </div>
    `).join("");
  }

  q.addEventListener("input", () => {
    SELECTED = null;
    const v = norm(q.value);
    if (!v) return suggestions.innerHTML = "";
    renderSuggestions(PRODUCTS.filter(p =>
      (norm(p.displayName) + " " + norm(p.keywords)).includes(v)
    ));
  });

  suggestions.addEventListener("click", e => {
    const el = e.target.closest("[data-code]");
    if (!el) return;
    SELECTED = PRODUCTS.find(p => p.code === el.dataset.code);
    q.value = SELECTED.displayName;
    suggestions.innerHTML = "";
    runSearch();
  });

  async function runSearch(){
    if (!SELECTED) return;
    results.innerHTML = `<div class="card">Searchingâ€¦</div>`;

    const res = await api("search", {
      q: SELECTED.displayName,
      ebayUrl: SELECTED.ebayUrl,
      productCode: SELECTED.code,
      productName: SELECTED.displayName
    });

    if (!res.ok) {
      results.innerHTML = `<div class="card">Error</div>`;
      return;
    }

    const rows = res.exportData || [];
    const kv = rows.map(r => `
      <div class="kv"><div>${r[0]}</div><div><b>${r[1]}</b></div></div>
    `).join("");

    const cm = SELECTED.checklistUrl ? `
      <div style="margin-top:12px">
        <a href="${SELECTED.checklistUrl}" target="_blank">
          <button class="primary">View on ChasingMajors</button>
        </a>
      </div>` : "";

    results.innerHTML = `<div class="card">${kv}${cm}</div>`;
  }

  document.getElementById("searchBtn").onclick = runSearch;
  document.getElementById("clearBtn").onclick = () => {
    q.value=""; suggestions.innerHTML=""; results.innerHTML=""; SELECTED=null;
  };

  async function loadProducts(){
    const res = await api("products",{});
    if (res.ok) PRODUCTS = res.products;
  }

  // Theme toggle
  const root = document.documentElement;
  const themeBtn = document.getElementById("themeToggle");
  let theme = localStorage.getItem("theme") || "dark";
  root.dataset.theme = theme;
  themeBtn.textContent = theme === "dark" ? "Dark" : "Light";

  themeBtn.onclick = () => {
    theme = theme === "dark" ? "light" : "dark";
    root.dataset.theme = theme;
    localStorage.setItem("theme", theme);
    themeBtn.textContent = theme === "dark" ? "Dark" : "Light";
  };

  loadProducts();
</script>
</body>
</html>
