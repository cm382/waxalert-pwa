<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WaxAlert</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b0b0b">

  <style>
    :root{
      --bg:#0b0b0b;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --card:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12);
      --input:#111;

      --primary:#ffffff;
      --primaryText:#000000;

      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius:16px;
    }

    [data-theme="light"]{
      --bg:#ffffff;
      --text:#111111;
      --muted:rgba(0,0,0,.62);
      --card:rgba(0,0,0,.04);
      --border:rgba(0,0,0,.12);
      --input:#ffffff;

      --primary:#111111;
      --primaryText:#ffffff;

      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    main{
      max-width:900px;
      margin:0 auto;
      padding:16px;
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .brand h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .brand .ver{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .btnSmall{
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .help{
      font-size:13px;
      line-height:1.35;
      color:var(--muted);
      margin-bottom:10px;
    }

    input{
      width:100%;
      box-sizing:border-box;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--input);
      color:var(--text);
      font-size:16px;
      outline:none;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .row > * { flex:1; }

    button{
      padding:12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      border:0;
      font-size:16px;
    }

    .primary{ background:var(--primary); color:var(--primaryText); }
    .ghost{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:800;
    }

    .list{
      margin-top:12px;
      display:grid;
      gap:10px;
    }

    .suggestion{
      cursor:pointer;
      padding:12px;
      border-radius:14px;
      background:var(--card);
      border:1px solid var(--border);
    }
    .suggestion b{ display:block; font-size:15px; line-height:1.2; }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid var(--border);
    }
    .kv:last-child{border-bottom:none}
    .k{color:var(--muted)}
    .v{font-weight:900;text-align:right}

    .btnLink{ text-decoration:none; display:block; margin-top:12px; }
  </style>
</head>

<body>
  <main>
    <div class="top">
      <div class="brand">
        <h1>WaxAlert</h1>
        <div class="ver">v5</div>
      </div>
      <button class="btnSmall" id="btnTheme">Light</button>
    </div>

    <div class="card">
      <div class="help">Start typing and tap a match. Matching uses your Products keywords, but only the product name is shown.</div>

      <input id="q" placeholder="Ex: 2025-26 Topps Midnight Basketball" />
      <div class="list" id="suggestions"></div>

      <div class="row">
        <button class="primary" id="searchBtn">Search</button>
        <button class="ghost" id="clearBtn">Clear Text</button>
      </div>
    </div>

    <div class="list" id="results"></div>
  </main>

  <script>
    // ✅ UPDATED to your current Apps Script deployment
    const API_URL = "https://script.google.com/macros/s/AKfycbyfFFhZUpuqj-S59anNujeWG_v3MVaKaOxwC_ollZTT2GfXeShjiX0pZiWf28nH60WF_Q/exec";

    // Register SW
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("/sw.js"));
    }

    // Theme button (v5 style)
    const THEME_KEY = "waxalert_theme";
    const btnTheme = document.getElementById("btnTheme");

    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme === "light" ? "light" : "dark");
      btnTheme.textContent = theme === "light" ? "Dark" : "Light";
    }

    function getTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "light" || saved === "dark") return saved;
      if (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) return "light";
      return "dark";
    }

    let theme = getTheme();
    applyTheme(theme);

    btnTheme.addEventListener("click", () => {
      theme = (theme === "dark") ? "light" : "dark";
      localStorage.setItem(THEME_KEY, theme);
      applyTheme(theme);
    });

    async function api(action, payload) {
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ action, payload })
      });
      return await res.json();
    }

    // Typeahead
    let PRODUCTS = [];
    let SELECTED = null;

    const q = document.getElementById("q");
    const suggestions = document.getElementById("suggestions");
    const results = document.getElementById("results");

    function norm(s){ return String(s||"").toLowerCase(); }
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    function renderSuggestions(list){
      if (!list.length) { suggestions.innerHTML = ""; return; }
      suggestions.innerHTML = list.slice(0, 12).map(p => `
        <div class="suggestion" data-code="${escapeHTML(p.code)}">
          <b>${escapeHTML(p.displayName)}</b>
        </div>
      `).join("");
    }

    q.addEventListener("input", () => {
      SELECTED = null;
      const v = norm(q.value).trim();
      if (!v) { suggestions.innerHTML = ""; return; }

      const matches = PRODUCTS.filter(p => {
        const hay = norm(p.displayName) + " " + norm(p.keywords) + " " + norm(p.code);
        return hay.includes(v);
      });

      renderSuggestions(matches);
    });

    suggestions.addEventListener("click", (e) => {
      const el = e.target.closest("[data-code]");
      if (!el) return;

      SELECTED = PRODUCTS.find(p => p.code === el.dataset.code);
      if (!SELECTED) return;

      q.value = SELECTED.displayName;
      suggestions.innerHTML = "";
      runSearch();
    });

    async function runSearch(){
      if (!SELECTED) return;

      results.innerHTML = `<div class="card"><div class="k">Searching…</div></div>`;

      const data = await api("search", {
        q: SELECTED.displayName,
        ebayUrl: SELECTED.ebayUrl,
        productCode: SELECTED.code,
        productName: SELECTED.displayName
      });

      if (!data || !data.ok) {
        results.innerHTML = `<div class="card"><div class="k">Error</div><div class="k">${escapeHTML(data?.error || "Unknown error")}</div></div>`;
        return;
      }

      const rows = Array.isArray(data.exportData) ? data.exportData : [];
      const kv = rows
        .filter(r => (String(r?.[0]||"").trim() || String(r?.[1]||"").trim()))
        .map(r => `
          <div class="kv">
            <div class="k">${escapeHTML(r[0] || "")}</div>
            <div class="v">${escapeHTML(r[1] || "")}</div>
          </div>
        `).join("");

      const cmUrl = SELECTED.checklistUrl ? String(SELECTED.checklistUrl).trim() : "";
      const cmBtn = cmUrl ? `
        <a class="btnLink" href="${escapeHTML(cmUrl)}" target="_blank" rel="noopener">
          <button class="primary" type="button">View details on ChasingMajors</button>
        </a>
      ` : "";

      results.innerHTML = `<div class="card">${kv || `<div class="k">No results yet.</div>`}${cmBtn}</div>`;
    }

    document.getElementById("searchBtn").addEventListener("click", runSearch);

    document.getElementById("clearBtn").addEventListener("click", () => {
      q.value = "";
      suggestions.innerHTML = "";
      results.innerHTML = "";
      SELECTED = null;
      q.focus();
    });

    q.addEventListener("keydown", (e) => {
      if (e.key === "Enter") runSearch();
    });

    // Product loader (cached + refresh)
    async function loadProducts(){
      // cached first
      try {
        const cached = localStorage.getItem("waxalert_products_cache_v1");
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Array.isArray(parsed)) PRODUCTS = parsed;
        }
      } catch(_) {}

      // refresh from API
      try {
        const data = await api("products", {});
        if (data && data.ok && Array.isArray(data.products)) {
          PRODUCTS = data.products;
          localStorage.setItem("waxalert_products_cache_v1", JSON.stringify(PRODUCTS));
        }
      } catch(_) {}
    }

    loadProducts();
  </script>
</body>
</html>
