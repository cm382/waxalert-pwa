<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WaxAlert</title>

  <!-- Bangers font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#0b0b0b" id="themeColorMeta">

  <style>
    :root { --navH: 62px; --radius: 14px; }

    /* ---------- THEME TOKENS ---------- */
    body {
      --bg:#0b0b0b;
      --text:#ffffff;
      --cardBg:rgba(255,255,255,0.08);
      --cardBorder:rgba(255,255,255,0.12);
      --muted:rgba(255,255,255,0.7);
      --inputBg:#111;
      --inputBorder:rgba(255,255,255,0.16);

      --btnPrimaryBg:#ffffff;
      --btnPrimaryText:#000000;

      --btnClearBg:transparent;
      --btnClearText:#ffffff;
      --btnClearBorder:rgba(255,255,255,0.22);

      --navBg:#0b0b0b;
      --navBorder:rgba(255,255,255,0.12);
      --navBtnBg:rgba(255,255,255,0.12);
      --navBtnIcon:#ffffff;

      --kvBorder:rgba(255,255,255,0.10);
      --accentBlue:#005FA3;
    }

    body.light {
      --bg:#ffffff;
      --text:#0b0b0b;
      --cardBg:rgba(0,0,0,0.05);
      --cardBorder:rgba(0,0,0,0.10);
      --muted:rgba(0,0,0,0.65);
      --inputBg:#ffffff;
      --inputBorder:rgba(0,0,0,0.18);

      --btnPrimaryBg:var(--accentBlue);
      --btnPrimaryText:#ffffff;

      --btnClearBg:#E0E0E0;
      --btnClearText:#000000;
      --btnClearBorder:#E0E0E0;

      --navBg:#ffffff;
      --navBorder:rgba(0,0,0,0.10);
      --navBtnBg:var(--accentBlue);
      --navBtnIcon:#ffffff;

      --kvBorder:rgba(0,0,0,0.10);
    }

    html, body { height:100%; }
    body {
      margin:0;
      font-family:Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      transition:background 150ms,color 150ms;
    }

    .content {
      padding:16px 16px calc(var(--navH) + 24px);
      max-width:900px;
      margin:0 auto;
    }

    /* ---------- HEADER ---------- */
    .headerRow {
      position:relative;
      margin:6px 0 12px;
      text-align:center;
    }

    .appTitle {
      font-family:"Bangers",cursive;
      font-size:34px;
      letter-spacing:1px;
      line-height:1;
    }
    .appTitle .big { font-size:42px; }

    .versionTag {
      margin-top:6px;
      font-size:11px;
      opacity:.6;
    }

    .themeToggle {
      position:absolute;
      right:0;
      top:0;
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--cardBorder);
      background:var(--cardBg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .themeIcon { width:22px;height:22px; }

    /* ---------- CARD ---------- */
    .card {
      background:var(--cardBg);
      border:1px solid var(--cardBorder);
      border-radius:16px;
      padding:16px;
    }

    .heroText {
      font-size:16px;
      font-weight:700; /* BOLD per v21 */
      margin-bottom:12px;
    }

    /* ---------- SEARCH ---------- */
    .searchWrap { position:relative; }
    .searchIcon {
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      width:18px;height:18px;
      opacity:.75;
    }

    input {
      width:100%;
      padding:12px 12px 12px 40px;
      border-radius:12px;
      border:1px solid var(--inputBorder);
      background:var(--inputBg);
      color:var(--text);
      font-size:16px;
      outline:none;
    }

    button.primary {
      width:100%;
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      border:0;
      background:var(--btnPrimaryBg);
      color:var(--btnPrimaryText);
      font-weight:700;
      cursor:pointer;
    }

    button.ghost {
      width:100%;
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      background:var(--btnClearBg);
      color:var(--btnClearText);
      border:1px solid var(--btnClearBorder);
      font-weight:700;
      cursor:pointer;
    }

    .list { margin-top:12px; display:grid; gap:10px; }

    .suggestion { cursor:pointer; }
    .suggestion .title { font-weight:700; }

    /* ---------- RESULTS ---------- */
    .kv {
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid var(--kvBorder);
    }
    .kv:last-child { border-bottom:0; }
    .k { opacity:.85; }
    .v { font-weight:700; text-align:right; }

    /* ---------- BOTTOM NAV ---------- */
    .bottomNav {
      position:fixed;
      left:0;right:0;bottom:0;
      height:var(--navH);
      background:var(--navBg);
      border-top:1px solid var(--navBorder);
      display:flex;
      justify-content:center;
    }

    .bottomNavInner {
      width:100%;
      max-width:900px;
      padding:10px 16px;
    }

    .navBtn {
      width:100%;
      height:42px;
      border-radius:14px;
      border:0;
      background:var(--navBtnBg);
      color:var(--navBtnIcon);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .navIcon { width:22px;height:22px; }
  </style>
</head>

<body>
  <main class="content">
    <section>

      <div class="headerRow">
        <div class="appTitle">
          <span class="big">W</span>ax<span class="big">A</span>lert
        </div>
        <div class="versionTag" id="versionTag"></div>
        <button class="themeToggle" id="btnTheme" aria-label="Toggle theme"></button>
      </div>

      <div class="card">
        <div class="heroText">
          Real-time box prices. Zero guesswork.
        </div>

        <div class="searchWrap">
          <svg class="searchIcon" viewBox="0 0 24 24" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
              stroke="currentColor" stroke-width="2"/>
            <path d="M16.8 16.8 21 21"
              stroke="currentColor" stroke-width="2"/>
          </svg>
          <input id="q" placeholder="What box are you searching for?" />
        </div>

        <div class="list" id="suggestions"></div>

        <button class="primary" id="btnSearch">Search</button>
        <button class="ghost" id="btnClear">Clear</button>
      </div>

      <div class="list" id="results"></div>
    </section>
  </main>

  <nav class="bottomNav">
    <div class="bottomNavInner">
      <button class="navBtn" id="btnHome" aria-label="Home">
        <svg class="navIcon" viewBox="0 0 24 24" fill="none">
          <path d="M3 10.5L12 3l9 7.5" stroke="currentColor" stroke-width="2"/>
          <path d="M5 9.8V21h14V9.8" stroke="currentColor" stroke-width="2"/>
          <path d="M10 21v-7h4v7" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>
  </nav>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxN9m7gStD_HgnOGSfjJzp7T9GQiYVhlMItgo5_YzUFe3Vrwe_GOsTVD0pndnnhk7a2MA/exec";
    const APP_VERSION = "v21";

    document.getElementById("versionTag").textContent = "Build " + APP_VERSION;

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () =>
        navigator.serviceWorker.register(`/sw.js?v=${APP_VERSION}`)
      );
    }

    document.getElementById("btnHome").onclick = () =>
      window.scrollTo({ top:0, behavior:"smooth" });

    /* ---------- THEME ---------- */
    const btnTheme = document.getElementById("btnTheme");
    const themeMeta = document.getElementById("themeColorMeta");

    const moon = `<svg class="themeIcon" viewBox="0 0 24 24" fill="none">
      <path d="M21 14.5A8.5 8.5 0 0 1 9.5 3a7 7 0 1 0 11.5 11.5Z"
        stroke="currentColor" stroke-width="2"/>
    </svg>`;

    const sun = `<svg class="themeIcon" viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
      <path d="M12 2v2M12 20v2M4 12H2M22 12h-2
               M5 5l1.5 1.5M17.5 17.5 19 19
               M19 5l-1.5 1.5M6.5 17.5 5 19"
        stroke="currentColor" stroke-width="2"/>
    </svg>`;

    function applyTheme(mode){
      const light = mode === "light";
      document.body.classList.toggle("light", light);
      localStorage.setItem("waxalert_theme", light ? "light" : "dark");
      btnTheme.innerHTML = light ? sun : moon;
      themeMeta.content = light ? "#ffffff" : "#0b0b0b";
    }

    applyTheme(localStorage.getItem("waxalert_theme") || "dark");

    btnTheme.onclick = () =>
      applyTheme(document.body.classList.contains("light") ? "dark" : "light");

    /* ---------- SEARCH LOGIC ---------- */
    const q = document.getElementById("q");
    const suggestions = document.getElementById("suggestions");
    const results = document.getElementById("results");
    const btnSearch = document.getElementById("btnSearch");
    const btnClear = document.getElementById("btnClear");

    let catalog = [];
    let selected = null;

    const api = async (a,p) =>
      JSON.parse(await (await fetch(API_URL,{
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body:JSON.stringify({ action:a, payload:p })
      })).text());

    fetch(API_URL,{method:"POST",headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:"products",payload:{}})})
      .then(r=>r.json()).then(d=>catalog=d.products||[]);

    const filter = t => catalog.filter(p =>
      (p.displayName+" "+p.keywords+" "+p.code).toLowerCase().includes(t));

    q.oninput = () => {
      selected=null;
      const t=q.value.toLowerCase().trim();
      suggestions.innerHTML = t ? filter(t).slice(0,12).map(p =>
        `<div class="card suggestion" data-code="${p.code}">
           <div class="title">${p.displayName}</div>
         </div>`).join("") : "";
    };

    suggestions.onclick = e => {
      const c=e.target.closest("[data-code]");
      if(!c) return;
      selected=catalog.find(p=>p.code===c.dataset.code);
      q.value=selected.displayName;
      suggestions.innerHTML="";
      if(selected.ebayUrl) run();
    };

    async function run(){
      const payload={ q:q.value };
      if(selected?.ebayUrl){
        payload.ebayUrl=selected.ebayUrl;
        payload.productCode=selected.code;
        payload.productName=selected.displayName;
      }
      results.innerHTML="<div class='card'>Searchingâ€¦</div>";
      const d=await fetch(API_URL,{method:"POST",headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:"search",payload})}).then(r=>r.json());
      results.innerHTML=d.exportData.map(r=>`
        <div class="kv"><div class="k">${r[0]}</div><div class="v">${r[1]}</div></div>
      `).join("");
    }

    btnSearch.onclick = run;
    q.onkeydown = e => e.key==="Enter" && (e.preventDefault(),run());
    btnClear.onclick = () => {
      q.value=""; suggestions.innerHTML=""; results.innerHTML=""; selected=null; q.focus();
    };
  </script>
</body>
</html>
